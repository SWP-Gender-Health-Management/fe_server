import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import PieChart from '../Chart/PieChart';
import './Dashboard.css';
import axios from 'axios';
import Cookies from 'js-cookie';

const API_URL = 'http://localhost:3000';

const Dashboard = () => {
  const navigate = useNavigate();
  const [kpiData, setKpiData] = useState({
    totalAppointments: 0,
    totalConRevenue: 0,
    totalLabRevenue: 0,
    totalMenstrual: 0,
  });

  const [quickStatsData, setQuickStatsData] = useState({
    totalPendingApp: 0,
    totalCompletedApp: 0,
    goodFeedPercent: 0,
    completedPercent: 0,
  });

  const [bookingMixData, setBookingMixData] = useState([
    { label: 'T∆∞ v·∫•n', value: 0, color: '#1054b9' },
    { label: 'X√©t nghi·ªám', value: 0, color: '#059669' },
  ]);

  useEffect(() => {
    fetchOveralKpi();
    fetchQuickStats();
    fetchBookingMix();
  }, []);

  const fetchOveralKpi = async () => {
    try {
      const accessToken = Cookies.get('accessToken');
      const accountId = Cookies.get('accountId');

      await axios.get(`${API_URL}/manager/get-overall`, {
        headers: { Authorization: `Bearer ${accessToken}` },
      }).then((response) => {
        const data = response.data.result;
        console.log("fetchOveralKpi data response: ", data);
        setKpiData(data);
      });
    } catch (error) {
      console.error("fetchOveralKpi error: ", error);
    }
  };

  const fetchQuickStats = async () => {
    try {
      const accessToken = Cookies.get('accessToken');
      const accountId = Cookies.get('accountId');

      await axios.get(`${API_URL}/manager/get-overall-weekly`, {
        headers: { Authorization: `Bearer ${accessToken}` },
      }).then((response) => {
        const data = response.data.result;
        console.log("fetchQuickStats data response: ", data);
        setQuickStatsData(data);
      });
    } catch (error) {
      console.error("fetchQuickStats error: ", error);
    }
  };

  const fetchBookingMix = async () => {
    try {
      const accessToken = Cookies.get('accessToken');
      const accountId = Cookies.get('accountId');
      await axios.get(`${API_URL}/manager/get-app-percent`, {
        headers: { Authorization: `Bearer ${accessToken}` },
      }).then((response) => {
        const data = response.data.result;
        console.log("fetchBookingMix data response: ", data);
        setBookingMixData([
          { label: 'T∆∞ v·∫•n', value: data.totalConApp, color: '#1054b9' },
          { label: 'X√©t nghi·ªám', value: data.totalLabApp, color: '#059669' },
        ]);
      });
    } catch (error) {
      console.error("fetchBookingMix error: ", error);
    }
  };




  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(amount);
  };

  const formatNumber = (num) => {
    return new Intl.NumberFormat('vi-VN').format(num);
  };

  const getStatusBadge = (status) => {
    const statusConfig = {
      confirmed: { text: 'ƒê√£ x√°c nh·∫≠n', color: '#10b981' },
      pending: { text: 'Ch·ªù x√°c nh·∫≠n', color: '#f59e0b' },
      cancelled: { text: 'ƒê√£ h·ªßy', color: '#ef4444' },
    };

    const config = statusConfig[status] || statusConfig.pending;

    return (
      <span
        className="status-badge"
        style={{
          backgroundColor: `${config.color}20`,
          color: config.color,
        }}
      >
        {config.text}
      </span>
    );
  };

  const formatDateTime = (dateTimeString) => {
    const date = new Date(dateTimeString);
    return {
      time: date.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
      }),
      date: date.toLocaleDateString('vi-VN'),
    };
  };

  return (
    <div className="manager-dashboard-page">
      <div className="dashboard-header">
        <h1>Business Dashboard</h1>
        <p>
          Today's service activity overview -{' '}
          {new Date().toLocaleDateString('vi-VN')}
        </p>
      </div>

      {/* KPI Cards */}
      <div className="kpi-grid">
        <div className="kpi-card">
          <div
            className="kpi-icon"
            style={{
              background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            }}
          >
            üìÖ
          </div>
          <div className="kpi-content">
            <div className="kpi-label">T·ªïng l·ªãch h·∫πn h√¥m nay</div>
            <div className="kpi-value">
              {formatNumber(kpiData.totalAppointments)}
            </div>
          </div>
        </div>

        <div className="kpi-card">
          <div
            className="kpi-icon"
            style={{
              background: 'linear-gradient(135deg, #059669 0%, #047857 100%)',
            }}
          >
            üí∞
          </div>
          <div className="kpi-content">
            <div className="kpi-label">Doanh thu t∆∞ v·∫•n</div>
            <div className="kpi-value">
              {formatCurrency(kpiData.totalConRevenue)}
            </div>

          </div>
        </div>

        <div className="kpi-card">
          <div
            className="kpi-icon"
            style={{
              background: 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)',
            }}
          >
            üß™
          </div>
          <div className="kpi-content">
            <div className="kpi-label">Doanh thu x√©t nghi·ªám</div>
            <div className="kpi-value">
              {formatCurrency(kpiData.totalLabRevenue)}
            </div>
          </div>
        </div>

        <div className="kpi-card">
          <div
            className="kpi-icon"
            style={{
              background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
            }}
          >
            üì±
          </div>
          <div className="kpi-content">
            <div className="kpi-label">Ng∆∞·ªùi d√πng m·ªõi theo d√µi chu k·ª≥</div>
            <div className="kpi-value">
              {formatNumber(kpiData.totalMenstrual)}
            </div>
            <div className="kpi-change neutral">H√¥m nay</div>
          </div>
        </div>
      </div>

      {/* Quick Actions */}
      {/* <div className="quick-actions-section">
        <div className="section-header">
          <h2>Quick Actions</h2>
          <p>Common management functions</p>
        </div>
        <div className="quick-actions-grid">
          <div
            className="quick-action-card"
            onClick={() => navigate('/manager/services')}
          >
            <div className="action-icon" style={{ backgroundColor: '#10b981' }}>
              üè•
            </div>
            <div className="action-content">
                          <div className="action-title">Service Management</div>
            <div className="action-description">
              Manage consultation, testing and cycle services
            </div>
            </div>
          </div>
          <div
            className="quick-action-card"
            onClick={() => navigate('/manager/blogs')}
          >
            <div className="action-icon" style={{ backgroundColor: '#8b5cf6' }}>
              üìù
            </div>
            <div className="action-content">
                          <div className="action-title">Blog Management</div>
            <div className="action-description">
              View and manage all articles in all statuses
            </div>
            </div>
          </div>
        </div>
      </div> */}

      {/* Main Dashboard Content */}
      <div className="dashboard-main">
        {/* Booking Mix Chart */}
        <div className="chart-section">
          <div className="section-header">
            <h2>Ph√¢n b·ªï l·ªãch h·∫πn</h2>
            <p>T·ª∑ l·ªá gi·ªØa t∆∞ v·∫•n v√† x√©t nghi·ªám trong 7 ng√†y qua</p>
          </div>
          <div className="chart-container">
            <PieChart data={bookingMixData} />
          </div>
          <div className="chart-legend">
            {bookingMixData.map((item, index) => (
              <div key={index} className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: item.color }}
                ></div>
                <span className="legend-label">
                  {item.label}: {item.value} l·ªãch h·∫πn
                </span>
              </div>
            ))}
          </div>
        </div>

        {/* Quick Stats */}
        <div className="quick-stats-section">
          <div className="section-header">
            <h2>Th·ªëng k√™ nhanh (7 ng√†y qua)</h2>
            <p>C√°c ch·ªâ s·ªë quan tr·ªçng kh√°c</p>
          </div>
          <div className="quick-stats-grid">
            <div className="stat-item">
              <div className="stat-icon">‚è∞</div>
              <div className="stat-content">
                <div className="stat-value">{quickStatsData.totalPendingApp}</div>
                <div className="stat-label"> L·ªãch h·∫πn ch·ªù x√°c nh·∫≠n</div>
              </div>
            </div>
            <div className="stat-item">
              <div className="stat-icon">‚úÖ</div>
              <div className="stat-content">
                <div className="stat-value">{quickStatsData.totalCompletedApp}</div>
                <div className="stat-label"> L·ªãch h·∫πn ƒë√£ x√°c nh·∫≠n</div>
              </div>
            </div>
            <div className="stat-item">
              <div className="stat-icon">üë®‚Äç‚öïÔ∏è</div>
              <div className="stat-content">
                <div className="stat-value">{quickStatsData.goodFeedPercent}%</div>
                <div className="stat-label"> T·ªâ l·ªá ƒë√°nh gi√° t·ªët</div>
              </div>
            </div>
            <div className="stat-item">
              <div className="stat-icon">üìä</div>
              <div className="stat-content">
                <div className="stat-value">{quickStatsData.completedPercent}%</div>
                <div className="stat-label"> T·ª∑ l·ªá ho√†n th√†nh</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Upcoming Appointments
      <div className="appointments-section">
        <div className="section-header">
          <h2>L·ªãch h·∫πn s·∫Øp t·ªõi</h2>
          <p>C√°c cu·ªôc h·∫πn g·∫ßn nh·∫•t c·∫ßn theo d√µi</p>
        </div>
        <div className="appointments-table">
          <table>
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>Kh√°ch h√†ng</th>
                <th>D·ªãch v·ª•</th>
                <th>Th·ªùi gian</th>
                <th>B√°c sƒ©</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
              {upcomingAppointments.map((appointment) => {
                const { time, date } = formatDateTime(appointment.time);
                return (
                  <tr key={appointment.id}>
                    <td>
                      <div className="appointment-type">
                        <span className="type-icon">
                          {getTypeIcon(appointment.type)}
                        </span>
                      </div>
                    </td>
                    <td>
                      <div className="customer-info">
                        <div className="customer-name">
                          {appointment.customerName}
                        </div>
                        <div className="customer-id">ID: {appointment.id}</div>
                      </div>
                    </td>
                    <td className="service-name">{appointment.serviceName}</td>
                    <td>
                      <div className="appointment-time">
                        <div className="time">{time}</div>
                        <div className="date">{date}</div>
                      </div>
                    </td>
                    <td>
                      <span className="consultant-name">
                        {appointment.consultant || 'Ch∆∞a ph√¢n c√¥ng'}
                      </span>
                    </td>
                    <td>{getStatusBadge(appointment.status)}</td>
                    <td>
                      <div className="appointment-actions">
                        <button className="action-btn view">üëÅ</button>
                        <button className="action-btn edit">‚úèÔ∏è</button>
                        <button className="action-btn more">‚ãÆ</button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        <div className="appointments-footer">
          <button className="view-all-btn">Xem t·∫•t c·∫£ l·ªãch h·∫πn</button>
        </div>
      </div> */}
    </div>
  );
};

export default Dashboard;
